

### 使用远程ipfs 作为中继和引导

1、【A】启动给一个节点，4001对外不能访问 webapi-port 端口开放

```shell script
nohup ./libp2p-chat --node-port=4001 --webapi-port=9090 --bootstraps=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ --relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ &

```
2、【B】启动给一个节点，4002对外能访问 webapi-port 端口开放

```shell script
nohup ./libp2p-chat --node-port=4002 --webapi-port=9091 --bootstraps=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ --relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ &

```
3、【C】在本地启动一个节点

```shell script
-node-port 4003 -webapi-port 9092 -bootstraps=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ -relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ

```

```html
<select id="server" onchange="changeServer()">
    <option value="http://110.42.187.187:9090" id="【A】">【A】</option>
    <option value="http://110.42.187.187:9091" id="【B】">【B】</option>
    <option value="http://localhost:9092" id="【C】">【C】</option>
</select>
```

测试结果：
【A-C】建立房间，由于 【A】的p2p端口4001 对外不能访问，所有需要采用中继连接

中继ipfs节点手动订阅房间
```shell script
ipfs pubsub sub chat/room/0947257f0b3cf850cd1f37ab59624699
```

如果再次关闭手动订阅的房间，不能进行通信。恢复订阅房间即可恢复通信

【A-B】建立房间 内网之间是可以正常通信，所以可以直接通信


### 【内网间测试】只使用内网中继

1、开启一个ipfs中继服务

/ip4/127.0.0.1/tcp/46127/p2p/12D3KooWR9ENG34L3BkiYZLND6PS4XaCbikeRt8RXYhevjsDyycS

2、在本地启动一个节点【A】

-node-port=4001 -webapi-port=9090 -relays=/ip4/127.0.0.1/tcp/46127/p2p/12D3KooWR9ENG34L3BkiYZLND6PS4XaCbikeRt8RXYhevjsDyycS


3、在本地启动一个节点【B】

-node-port 4003 -webapi-port 9092 -relays=/ip4/127.0.0.1/tcp/46127/p2p/12D3KooWR9ENG34L3BkiYZLND6PS4XaCbikeRt8RXYhevjsDyycS

```html
<select id="server" onchange="changeServer()">
    <option value="http://localhost:9090" id="userAA">AA</option>
    <option value="http://localhost:9092" id="userBB">BB</option>
</select>
```

经测试
【A-B】之间建立房间，然后在ipfs中继服务进行房间的订阅，可以正常通信
没有订阅的时候，不能进行通信
```shell script
kevin@DESKTOP-SMS02PU:~/.ipfs$ ipfs pubsub ls
chat/room/4276d50f05d2cac4c98c17337ac30c99
```


### 【内网间测试】只使用公网中继

1、开启一个ipfs中继服务

/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ

2、在本地启动一个节点【A】

-node-port=4001 -webapi-port=9090 -relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ


3、在本地启动一个节点【B】

-node-port 4003 -webapi-port 9092 -relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ

```html
<select id="server" onchange="changeServer()">
    <option value="http://localhost:9090" id="userAA">AA</option>
    <option value="http://localhost:9092" id="userBB">BB</option>
</select>
```

经测试结果
【A-B】组成房间，虽然没有在ipfs节点进行订阅，然后可以进行通信


### 【公网-内网测试】只使用公网中继

1、开启一个ipfs中继服务

/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ

2、在远程启动一个节点【A】4001对外不能访问 webapi-port 端口开放

nohup ./libp2p-chat --node-port=4001 --webapi-port=9090 --relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ &


3、在本地启动一个节点【B】

-node-port 4003 -webapi-port 9092 -relays=/ip4/112.124.44.121/tcp/4001/p2p/12D3KooWKff4bsrFYwKmn6HEDi4jaBxN63oW1iMinqhN36sFKzyQ

```html
<select id="server" onchange="changeServer()">
    <option value="http://110.42.187.187:9090" id="userAA">AA</option>
    <option value="http://localhost:9092" id="userBB">BB</option>
</select>
```

经测试结果
【A-B】组成房间，ipfs节点进行订阅，然后可以进行通信

ipfs pubsub sub chat/room/4276d50f05d2cac4c98c17337ac30c99

如果不进行订阅，则不能通信


### 使用berty 中继和引导 公网测试

本场景 在公共网络上面测试

1、远程启动节点

```shell script
./libp2p-chat --node-port=4001 --webapi-port=9090 --bootstraps=/ip4/147.182.224.101/tcp/4001/p2p/12D3KooWK8jpU2JBH7EPxff7USznSixypCYNecncNhsrzrYLQRiA --relays=/ip4/51.15.25.224/tcp/4040/p2p/12D3KooWHhDBv6DJJ4XDWjzEXq6sVNEs6VuxsV1WyBBEhPENHzcZ

```
2、 本地启动一个节点

```shell script
-node-port 4003 -webapi-port 9092 -relays=/ip4/51.15.25.224/tcp/4040/p2p/12D3KooWHhDBv6DJJ4XDWjzEXq6sVNEs6VuxsV1WyBBEhPENHzcZ -bootstraps=/ip4/147.182.224.101/tcp/4001/p2p/12D3KooWK8jpU2JBH7EPxff7USznSixypCYNecncNhsrzrYLQRiA

``` 

测试结论：
1、情景1
berty的中继节点作为中继节点，和一个public ipfs作为引导节点，pubsub可以通
在该情况下，没有在中继上面进行手动订阅房间

2、情景2
单独使用public ipfs作为引导节点，不能通信

3、情景3
单独使用berty 中继，在出现该连接之间，不能通信。建立该种连接之后就可以通信
```
2022-10-20T17:30:18.384+0800    DEBUG   node/node.go:270        node multiaddr:/ip4/51.15.25.224/udp/4040/quic/p2p/12D3KooWHhDBv6DJJ4XDWjzEXq6sVNEs6VuxsV1WyBBEhPENHzcZ/p2p-circuit
2022-10-20T17:30:18.384+0800    DEBUG   node/node.go:270        node multiaddr:/ip4/51.15.25.224/tcp/4040/p2p/12D3KooWHhDBv6DJJ4XDWjzEXq6sVNEs6VuxsV1WyBBEhPENHzcZ/p2p-circuit
```
